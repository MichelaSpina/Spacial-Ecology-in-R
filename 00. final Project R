library(imageRy)
library(terra)
library(viridis)
library(raster)

#impost directory
getwd()
setwd("C:/Users/Utente/OneDrive - Universit√† di Napoli Federico II/Desktop/Final R project/provo bande 3,4,8")
getwd()

list.files()

#importing images 23,24 in true color
Sic23tc <- rast("2023-01-02-Sentinel-2_L2A_27True_color.tiff")
Sic24tc <- rast("2024-01-02-Sentinel-2_L2A_27True_color.tiff")

#verify that class is SpatRaster
Sic23tc
Sic24tc


#assign color palette
cl <- magma(100)


#plot true color 23-24
par(mfrow=c(1,2))
plot(Sic23tc)
plot(Sic24tc)


#DIFFERENTIAL VEGETATION INDEX 2023
Sic23b04 <- rast("2023-01-02-Sentinel-2_L2A_B04_27(Raw).tiff")
Sic23b08 <- rast("2023-01-02-Sentinel-2_L2A_B08_27(Raw).tiff")

DVI_2023 <- Sic23b04 - Sic23b08
DVI_2023


dev.off()

par(mfrow=c(1,2))

plot(DVI_2023)

#DIFFERENTIAL VEGETATION INDEX 2024
Sic24b04 <- rast("2024-01-02-Sentinel-2_L2A_B04_27(Raw).tiff")
Sic24b08 <- rast("2024-01-02-Sentinel-2_L2A_B08_27(Raw).tiff")

DVI_2024 <- Sic24b04 - Sic24b08
DVI_2024

plot(DVI_2024)


#summary DVI 
summary(DVI_2023)
summary(DVI_2024)



# define specific extention in order to not include some clouds at the edges
ext <- ext(c(xmin = 14, xmax = 15, ymin = 37.4, ymax = 37.8))

#zoomed DVI using crop function
DVI_2023ext <- crop(Sic23b04 - Sic23b08, ext)
DVI_2024ext <- crop(Sic24b04 - Sic24b08, ext)

#clamp NDVI 2024 to obtain the same interval
DVI_2024ext_clamped <- clamp(DVI_2024ext, lower = -150, upper = 150)

#descriptive statistics: summary DVI ext
summary(DVI_2023ext)
summary(DVI_2024ext)

DVI_2023ext
DVI_2024ext


#plot DVI ext 2023  2024
dev.off()
par(mfrow=c(1,2))
plot(DVI_2023ext, main="DVI 2023", col=cl)
plot(DVI_2024ext_clamped, main="DVI 2024", col=cl)



#difference between DVI ext 2023 and 2024 and summary
dev.off()
DVI_diff <- DVI_2024ext_clamped - DVI_2023ext
plot(DVI_diff, main="Variazione DVI (2024-2023)", col=cl)
summary(DVI_diff)

#histogram to have a quantitative panoramic about the dispersion of data o understand the variability of our data
histoDVI23 <- hist(DVI_2023ext, main="Istogramma DVI 2023", xlab="Valore DVI", ylab="Frequenza", col="lightblue", border="black")
histoDVI24 <- hist(DVI_2024ext, main="Istogramma DVI 2023", xlab="Valore DVI", ylab="Frequenza", col="lightblue", border="black")
dev.off()
par(mfrow=c(1,2))
plot(histoDVI23, main="DVI 2023", col=cl)
plot(histoDVI24, main="DVI 2024", col=cl)
histoDVI23
histoDVI24



#NORMALIZED DIFFERENT VEGETATION INDEX 2023 and 2024
dev.off()
ndvi2023 = crop((Sic23b08 - Sic23b04) / (Sic23b04 + Sic23b08), ext)
ndvi2024 = crop((Sic24b08 - Sic24b04) / (Sic24b04 + Sic24b08), ext)
par(mfrow=c(1,2))
plot(ndvi2023, main="NDVI 2023", col=cl)
plot(ndvi2024, main="NDVI 2024", col=cl)

#NDVI difference
dev.off()
ndvi_diff <- ndvi2024 - ndvi2023
ndvi_diff_clamped <-clamp(ndvi_diff, lower = -1, upper = 1)
plot(ndvi_diff_clamped, main="VARIAZIONE NDVI (2023-2024)", col=cl)

#visualize 3 images in a row
dev.off()
par(mfrow=c(1,3)) 

plot(ndvi2023, main="NDVI 2023", col=cl)
plot(ndvi2024, main="NDVI 2024", col=cl)
plot(ndvi_diff_clamped, main="Differenza NDVI 2024 - 2023", col=cl)

#descriptive statistics
summary(ndvi2023)
summary(ndvi2024)
summary(ndvi_diff_clamped)

#green band
Sic23b03 <- rast("2023-01-02-Sentinel-2_L2A_B03_27(Raw).tiff")
Sic24b03 <- rast("2024-01-02-Sentinel-2_L2A_B03_27(Raw).tiff")

#NORMALIZED WATER INDEX (NDWI)
NDWI_2023 <- (Sic23b08 - Sic23b03) / (Sic23b08 + Sic23b03)
NDWI_2024 <- (Sic24b08 - Sic24b03) / (Sic24b08 + Sic24b03)

#extended version
NDWI_2023ext <- crop((Sic23b08 - Sic23b03) / (Sic23b08 + Sic23b03),ext)
NDWI_2024ext <- crop((Sic24b08 - Sic24b03) / (Sic24b08 + Sic24b03), ext)

NDWI_2023
NDWI_2024
NDWI_2023ext
NDWI_2024ext 

dev.off()
par(mfrow=c(1,2))

plot(NDWI_2023, main="NDWI 2023", col=cl)
plot(NDWI_2024, main="NDWI 2024", col=cl)

NDWI_diff_ext <- NDWI_2024ext - NDWI_2023ext

#NDWI extended version
dev.off()

par(mfrow=c(1,2))
plot(NDWI_2023ext, main="NDWI 2023", col=cl)
plot(NDWI_2024ext, main="NDWI 2024", col=cl)

dev.off()

plot(NDWI_diff, main="Differenza NDWI 2024 - 2023", col=cl)

#descriptive statistics
summary(NDWI_2023)
summary(NDWI_2024)

summary(NDWI_2023ext)
summary(NDWI_2024ext)
summary(NDWI_diff_ext)


#ENHANCED VEGETATION INDEX
EVI_2023 <- crop(2.5 * (Sic23b08 - Sic23b04) / (Sic23b08 + 6 * Sic23b04 - 7.5 * Sic23b03 + 100),ext)
EVI_2024 <- crop(2.5 * (Sic24b08 - Sic24b04) / (Sic24b08 + 6 * Sic24b04 - 7.5 * Sic24b03 + 100),ext)

#clamp intervals
EVI_2023cl <- clamp(EVI_2023,lower=-1, upper=1)
EVI_2024cl <- clamp(EVI_2024,lower=-1, upper=1)

#plot EVI
dev.off()
par(mfrow=c(1,2))

plot(EVI_2023cl,main="EVI 2023",col=cl)
plot(EVI_2024cl,main="EVI 2024",col=cl)

#descriptive statistics
summary(EVI_2023cl)
summary(EVI_2024cl)

